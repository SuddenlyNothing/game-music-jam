[gd_scene load_steps=45 format=2]

[ext_resource path="res://assets/environment/room/room_background.png" type="Texture" id=1]
[ext_resource path="res://assets/environment/room/trash_can.png" type="Texture" id=2]
[ext_resource path="res://assets/environment/room/weights.png" type="Texture" id=3]
[ext_resource path="res://scenes/environment/MinigamesManager.tscn" type="PackedScene" id=4]
[ext_resource path="res://assets/environment/room/bed.png" type="Texture" id=5]
[ext_resource path="res://assets/environment/room/desk.png" type="Texture" id=6]
[ext_resource path="res://assets/environment/room/door.png" type="Texture" id=7]
[ext_resource path="res://assets/environment/outside/fall/background.png" type="Texture" id=8]
[ext_resource path="res://assets/environment/outside/fall/foreground.png" type="Texture" id=9]
[ext_resource path="res://assets/environment/outside/summer/background.png" type="Texture" id=10]
[ext_resource path="res://assets/environment/outside/summer/foreground.png" type="Texture" id=11]
[ext_resource path="res://assets/environment/outside/spring/background.png" type="Texture" id=12]
[ext_resource path="res://assets/environment/outside/spring/foreground.png" type="Texture" id=13]
[ext_resource path="res://assets/environment/outside/winter/background.png" type="Texture" id=14]
[ext_resource path="res://assets/environment/outside/winter/foreground.png" type="Texture" id=15]
[ext_resource path="res://assets/particles/leaves.png" type="Texture" id=16]
[ext_resource path="res://assets/particles/snow.png" type="Texture" id=17]
[ext_resource path="res://scenes/environment/Room.gd" type="Script" id=18]
[ext_resource path="res://assets/environment/room/light_under.png" type="Texture" id=19]
[ext_resource path="res://assets/environment/room/lights_over.png" type="Texture" id=20]
[ext_resource path="res://scenes/environment/Enterable.tscn" type="PackedScene" id=21]
[ext_resource path="res://assets/environment/room/window.png" type="Texture" id=22]
[ext_resource path="res://assets/characters/mc/mc_idle.png" type="Texture" id=23]
[ext_resource path="res://assets/sfx/ambient/room/room_clock.ogg" type="AudioStream" id=24]
[ext_resource path="res://assets/sfx/ambient/outdoor/outdoor_ambient_fall_loop.ogg" type="AudioStream" id=25]
[ext_resource path="res://assets/sfx/ambient/outdoor/outdoor_ambient_spring_loop.ogg" type="AudioStream" id=26]
[ext_resource path="res://assets/sfx/ambient/outdoor/outdoor_ambient_summer_loop.ogg" type="AudioStream" id=27]
[ext_resource path="res://assets/sfx/ambient/outdoor/outdoor_ambient_winter_loop.ogg" type="AudioStream" id=28]
[ext_resource path="res://assets/particles/rain.png" type="Texture" id=29]
[ext_resource path="res://assets/environment/outside/cover.png" type="Texture" id=30]
[ext_resource path="res://assets/environment/room/window_mask.png" type="Texture" id=31]
[ext_resource path="res://assets/sfx/scene/act1/act1_player_open_close_door.ogg" type="AudioStream" id=32]

[sub_resource type="CanvasItemMaterial" id=1]
particles_animation = true
particles_anim_h_frames = 5
particles_anim_v_frames = 1
particles_anim_loop = false

[sub_resource type="Curve" id=2]
_data = [ Vector2( 0, 0 ), 0.0, 0.0, 0, 0, Vector2( 0.197044, 1 ), 0.0, 0.0, 0, 0, Vector2( 0.70936, 1 ), 0.0, 0.0, 0, 0, Vector2( 1, 0 ), -3.28114, 0.0, 0, 0 ]

[sub_resource type="CanvasItemMaterial" id=3]
particles_animation = true
particles_anim_h_frames = 4
particles_anim_v_frames = 1
particles_anim_loop = false

[sub_resource type="Curve" id=4]
_data = [ Vector2( 0, 0 ), 0.0, 0.0, 0, 0, Vector2( 0.118227, 1 ), 0.0, 0.0, 0, 0, Vector2( 0.79803, 1 ), 0.0, 0.0, 0, 0, Vector2( 1, 0 ), 0.0, 0.0, 0, 0 ]

[sub_resource type="CanvasItemMaterial" id=11]
particles_animation = true
particles_anim_h_frames = 8
particles_anim_v_frames = 1
particles_anim_loop = false

[sub_resource type="Shader" id=12]
code = "shader_type canvas_item;

void fragment() {
	COLOR = texture(SCREEN_TEXTURE, SCREEN_UV);
	COLOR.a = texture(TEXTURE, UV).a;
}"

[sub_resource type="ShaderMaterial" id=13]
shader = SubResource( 12 )

[sub_resource type="Shader" id=6]
code = "shader_type canvas_item;
render_mode unshaded;

uniform float line_scale : hint_range(0, 4) = 1.0;

//If not using a texture, will blend between these two colors
uniform vec4 outline_color : hint_color;

varying vec2 o;
varying vec2 f;

void vertex()
{
	//Expands the vertexes so we have space to draw the outline if we were on the edge.
	o = VERTEX;
	vec2 uv = (UV - 0.5);
	VERTEX += uv * line_scale * TEXTURE_PIXEL_SIZE * 100.0;
	f = VERTEX;
}

void fragment()
{
	ivec2 t = textureSize(TEXTURE, 0);
	vec2 regular_uv;
	regular_uv.x = UV.x + (f.x - o.x)/float(t.x);
	regular_uv.y = UV.y + (f.y - o.y)/float(t.y);
	
	vec4 regular_color = texture(TEXTURE, regular_uv);
	
	if((regular_uv.x < 0.0 || regular_uv.x > 1.0) || (regular_uv.y < 0.0 || regular_uv.y > 1.0) || regular_color.a <=0.25){
		regular_color = vec4(0.0); 
	}
	
	vec2 ps = TEXTURE_PIXEL_SIZE * line_scale;
	
	vec4 final_color = regular_color;
	if (regular_color.a <= 0.0)
	{
		
		vec2 outline_uv = regular_uv + vec2(1.0 * ps.x, 0.0 * ps.y); 
		vec4 outline_sample = texture(TEXTURE, outline_uv);
		if((outline_uv.x < 0.0 || outline_uv.x > 1.0) || (outline_uv.y < 0.0 || outline_uv.y > 1.0)){
			outline_sample = vec4(0);
		}
		if(outline_sample.a > final_color.a){
			final_color = outline_color;
		}
		
		outline_uv = regular_uv + vec2(-1.0 * ps.x, 0.0 * ps.y); 
		outline_sample = texture(TEXTURE, outline_uv);
		if((outline_uv.x < 0.0 || outline_uv.x > 1.0) || (outline_uv.y < 0.0 || outline_uv.y > 1.0)){
			outline_sample = vec4(0);
		}
		if(outline_sample.a > final_color.a){
			final_color = outline_color;
		}
		
		outline_uv = regular_uv + vec2(0.0 * ps.x, -1.0 * ps.y); 
		outline_sample = texture(TEXTURE, outline_uv);
		if((outline_uv.x < 0.0 || outline_uv.x > 1.0) || (outline_uv.y < 0.0 || outline_uv.y > 1.0)){
			outline_sample = vec4(0);
		}
		if(outline_sample.a > final_color.a){
			final_color = outline_color;
		}
		
		outline_uv = regular_uv + vec2(0.0 * ps.x, 1.0 * ps.y); 
		outline_sample = texture(TEXTURE, outline_uv);
		if((outline_uv.x < 0.0 || outline_uv.x > 1.0) || (outline_uv.y < 0.0 || outline_uv.y > 1.0)){
			outline_sample = vec4(0);
		}
		if(outline_sample.a > final_color.a){
			final_color = outline_color;
		}
	}
	COLOR = final_color; 
}"

[sub_resource type="ShaderMaterial" id=7]
resource_local_to_scene = true
shader = SubResource( 6 )
shader_param/line_scale = 0.0
shader_param/outline_color = Color( 1, 1, 1, 1 )

[sub_resource type="ShaderMaterial" id=8]
resource_local_to_scene = true
shader = SubResource( 6 )
shader_param/line_scale = 0.0
shader_param/outline_color = Color( 1, 1, 1, 1 )

[sub_resource type="ShaderMaterial" id=9]
resource_local_to_scene = true
shader = SubResource( 6 )
shader_param/line_scale = 0.0
shader_param/outline_color = Color( 1, 1, 1, 1 )

[sub_resource type="ShaderMaterial" id=10]
resource_local_to_scene = true
shader = SubResource( 6 )
shader_param/line_scale = 0.0
shader_param/outline_color = Color( 1, 1, 1, 1 )

[node name="Room" type="Node2D"]
script = ExtResource( 18 )

[node name="Audio" type="Node" parent="."]

[node name="Indoor" type="Node" parent="Audio"]

[node name="Clock" type="AudioStreamPlayer" parent="Audio/Indoor"]
stream = ExtResource( 24 )
bus = "SFX Indoor"

[node name="Outdoor" type="Node" parent="Audio"]

[node name="Fall" type="AudioStreamPlayer" parent="Audio/Outdoor"]
stream = ExtResource( 25 )
bus = "SFX Outdoor"

[node name="Spring" type="AudioStreamPlayer" parent="Audio/Outdoor"]
stream = ExtResource( 26 )
bus = "SFX Outdoor"

[node name="Summer" type="AudioStreamPlayer" parent="Audio/Outdoor"]
stream = ExtResource( 27 )
volume_db = -20.0
bus = "SFX Outdoor"

[node name="Winter" type="AudioStreamPlayer" parent="Audio/Outdoor"]
stream = ExtResource( 28 )
bus = "SFX Outdoor"

[node name="DoorSFX" type="AudioStreamPlayer" parent="Audio"]
stream = ExtResource( 32 )
bus = "SFX"

[node name="ParallaxBackground" type="ParallaxBackground" parent="."]

[node name="ParallaxLayer" type="ParallaxLayer" parent="ParallaxBackground"]
motion_mirroring = Vector2( 448, 256 )

[node name="ColorRect" type="ColorRect" parent="ParallaxBackground/ParallaxLayer"]
margin_right = 448.0
margin_bottom = 256.0
mouse_filter = 2
color = Color( 0, 0, 0, 1 )

[node name="Outside" type="Node2D" parent="."]
position = Vector2( 192, 128 )
z_index = -100

[node name="Summer" type="Node2D" parent="Outside"]

[node name="Background" type="Sprite" parent="Outside/Summer"]
texture = ExtResource( 10 )

[node name="Foreground" type="Sprite" parent="Outside/Summer"]
z_index = 70
texture = ExtResource( 11 )

[node name="Fall" type="Node2D" parent="Outside"]
visible = false

[node name="Background" type="Sprite" parent="Outside/Fall"]
texture = ExtResource( 8 )

[node name="Leaves" type="CPUParticles2D" parent="Outside/Fall/Background"]
material = SubResource( 1 )
position = Vector2( 0, -64 )
amount = 16
lifetime = 5.0
preprocess = 10.0
texture = ExtResource( 16 )
emission_shape = 2
emission_rect_extents = Vector2( 192, 128 )
spread = 180.0
gravity = Vector2( 0, 10 )
initial_velocity = 20.0
initial_velocity_random = 1.0
angular_velocity = 100.0
angular_velocity_random = 1.0
scale_amount_curve = SubResource( 2 )
anim_offset = 1.0
anim_offset_random = 1.0

[node name="Foreground" type="Sprite" parent="Outside/Fall"]
z_index = 70
texture = ExtResource( 9 )

[node name="Leaves" type="CPUParticles2D" parent="Outside/Fall/Foreground"]
material = SubResource( 1 )
position = Vector2( 0, -64 )
z_index = -70
amount = 16
lifetime = 5.0
preprocess = 10.0
texture = ExtResource( 16 )
emission_shape = 2
emission_rect_extents = Vector2( 192, 128 )
spread = 180.0
gravity = Vector2( 0, 10 )
initial_velocity = 20.0
initial_velocity_random = 1.0
angular_velocity = 100.0
angular_velocity_random = 1.0
scale_amount_curve = SubResource( 2 )
anim_offset = 1.0
anim_offset_random = 1.0

[node name="Winter" type="Node2D" parent="Outside"]
visible = false

[node name="Background" type="Sprite" parent="Outside/Winter"]
texture = ExtResource( 14 )

[node name="Snow" type="CPUParticles2D" parent="Outside/Winter/Background"]
material = SubResource( 3 )
position = Vector2( 0, -64 )
amount = 20
lifetime = 8.0
preprocess = 30.0
texture = ExtResource( 17 )
emission_shape = 2
emission_rect_extents = Vector2( 192, 128 )
direction = Vector2( 0, 1 )
spread = 90.0
gravity = Vector2( 0, 5 )
initial_velocity = 10.0
initial_velocity_random = 1.0
scale_amount_curve = SubResource( 4 )
anim_offset = 1.0
anim_offset_random = 1.0

[node name="Foreground" type="Sprite" parent="Outside/Winter"]
z_index = 70
texture = ExtResource( 15 )

[node name="Snow" type="CPUParticles2D" parent="Outside/Winter/Foreground"]
material = SubResource( 3 )
position = Vector2( 0, -64 )
z_index = -70
amount = 20
lifetime = 8.0
preprocess = 30.0
texture = ExtResource( 17 )
emission_shape = 2
emission_rect_extents = Vector2( 192, 128 )
direction = Vector2( 0, 1 )
spread = 90.0
gravity = Vector2( 0, 5 )
initial_velocity = 10.0
initial_velocity_random = 1.0
scale_amount_curve = SubResource( 4 )
anim_offset = 1.0
anim_offset_random = 1.0

[node name="Spring" type="Node2D" parent="Outside"]
visible = false

[node name="Background" type="Sprite" parent="Outside/Spring"]
texture = ExtResource( 12 )

[node name="Rain" type="CPUParticles2D" parent="Outside/Spring/Background"]
material = SubResource( 11 )
amount = 16
lifetime = 0.5
texture = ExtResource( 29 )
emission_shape = 2
emission_rect_extents = Vector2( 192, 140 )
gravity = Vector2( 0, 0 )
anim_speed = 2.0
anim_speed_random = 0.5

[node name="Foreground" type="Sprite" parent="Outside/Spring"]
z_index = 70
texture = ExtResource( 13 )

[node name="Rain" type="CPUParticles2D" parent="Outside/Spring/Foreground"]
material = SubResource( 11 )
amount = 16
lifetime = 0.5
texture = ExtResource( 29 )
emission_shape = 2
emission_rect_extents = Vector2( 192, 140 )
gravity = Vector2( 0, 0 )
anim_speed = 2.0
anim_speed_random = 0.5

[node name="Cover" type="BackBufferCopy" parent="Outside"]
modulate = Color( 1, 1, 1, 0 )
z_index = 190
copy_mode = 2

[node name="Cover" type="Sprite" parent="Outside/Cover"]
texture = ExtResource( 30 )

[node name="Window" type="Sprite" parent="Outside/Cover"]
material = SubResource( 13 )
position = Vector2( 134, 72 )
texture = ExtResource( 31 )

[node name="YSort" type="YSort" parent="."]
z_index = 100

[node name="RoomElements" type="YSort" parent="YSort"]
position = Vector2( 326, 200 )

[node name="RoomBackground" type="Sprite" parent="YSort/RoomElements"]
z_index = -5
texture = ExtResource( 1 )

[node name="Enterables" type="YSort" parent="YSort/RoomElements"]

[node name="Desk" parent="YSort/RoomElements/Enterables" instance=ExtResource( 21 )]
material = SubResource( 7 )
position = Vector2( 0, -1 )

[node name="Default" type="Sprite" parent="YSort/RoomElements/Enterables/Desk"]
use_parent_material = true
position = Vector2( 0, 1 )
texture = ExtResource( 6 )

[node name="Entered" type="Sprite" parent="YSort/RoomElements/Enterables/Desk"]
visible = false
use_parent_material = true
position = Vector2( 0, 1 )
texture = ExtResource( 6 )

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Enterables/Desk"]
polygon = PoolVector2Array( -8, 29.5, 10, 37.5, 20, 35.5, 28, 23.5, 28, 15.5, 18, 9.5, -8, 23.5 )

[node name="Window" parent="YSort/RoomElements/Enterables" instance=ExtResource( 21 )]
material = SubResource( 8 )

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Enterables/Window"]
polygon = PoolVector2Array( -56, 27.5, -56, 29.5, -54, 29.5, -30, 17.5, -32, 15.5 )

[node name="Default" type="Sprite" parent="YSort/RoomElements/Enterables/Window"]
use_parent_material = true
texture = ExtResource( 22 )

[node name="Entered" type="Sprite" parent="YSort/RoomElements/Enterables/Window"]
visible = false
use_parent_material = true
texture = ExtResource( 22 )

[node name="Sprite" type="Sprite" parent="YSort/RoomElements/Enterables/Window/Entered"]
position = Vector2( -42, -2.5 )
texture = ExtResource( 23 )
flip_h = true
region_enabled = true
region_rect = Rect2( 0, 0, 64, 64 )

[node name="Weights" parent="YSort/RoomElements/Enterables" instance=ExtResource( 21 )]
material = SubResource( 9 )

[node name="Default" type="Sprite" parent="YSort/RoomElements/Enterables/Weights"]
use_parent_material = true
texture = ExtResource( 3 )

[node name="Entered" type="Sprite" parent="YSort/RoomElements/Enterables/Weights"]
visible = false
use_parent_material = true
texture = ExtResource( 3 )

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Enterables/Weights"]
polygon = PoolVector2Array( -67, 63.5, -40, 75.5, -26, 71.5, -57, 55.5 )

[node name="Bed" parent="YSort/RoomElements/Enterables" instance=ExtResource( 21 )]
material = SubResource( 10 )

[node name="Default" type="Sprite" parent="YSort/RoomElements/Enterables/Bed"]
use_parent_material = true
z_index = 10
texture = ExtResource( 5 )

[node name="Entered" type="Sprite" parent="YSort/RoomElements/Enterables/Bed"]
visible = false
use_parent_material = true
z_index = 10
texture = ExtResource( 5 )

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Enterables/Bed"]
polygon = PoolVector2Array( -22, 89.5, 3, 102.5, 51, 77.5, 26, 65.5 )

[node name="TrashCan" type="Sprite" parent="YSort/RoomElements"]
position = Vector2( 0, 39 )
texture = ExtResource( 2 )
offset = Vector2( 0, -39 )

[node name="Door" type="Sprite" parent="YSort/RoomElements"]
texture = ExtResource( 7 )

[node name="LightUnder" type="Sprite" parent="YSort/RoomElements"]
texture = ExtResource( 19 )

[node name="LightsOver" type="Sprite" parent="YSort/RoomElements"]
position = Vector2( 0, 45 )
z_index = 20
texture = ExtResource( 20 )
offset = Vector2( 0, -45 )

[node name="Collisions" type="Node2D" parent="YSort/RoomElements"]
z_index = 1

[node name="StaticBody2D" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D"]
polygon = PoolVector2Array( -102, 53.5, 4, -0.5, 0, -2.5, -106, 51.5 )

[node name="StaticBody2D2" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D2"]
position = Vector2( 106, 53.5 )
polygon = PoolVector2Array( -104, 54, 4, -0.5, 0, -2.5, -108, 52 )

[node name="StaticBody2D3" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D3"]
position = Vector2( 4, 55.5 )
polygon = PoolVector2Array( -2, 52, 2, 50, -106, -4, -110, -2 )

[node name="StaticBody2D4" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D4"]
position = Vector2( 106, 1.5 )
polygon = PoolVector2Array( -2, 52, 2, 50, -106, -4, -110, -2 )

[node name="StaticBody2D5" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D5"]
position = Vector2( 106, 1.5 )
polygon = PoolVector2Array( -6, 50, -18, 56, -54, 38, -56, 24 )

[node name="StaticBody2D6" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D6"]
position = Vector2( 106, 1.5 )
polygon = PoolVector2Array( -176, 34, -162, 42, -152, 38, -162, 26 )

[node name="StaticBody2D7" type="StaticBody2D" parent="YSort/RoomElements/Collisions"]

[node name="CollisionPolygon2D" type="CollisionPolygon2D" parent="YSort/RoomElements/Collisions/StaticBody2D7"]
position = Vector2( 106, 1.5 )
polygon = PoolVector2Array( -142, 16, -114, 28, -114, 22, -136, 12 )

[node name="MinigamesManager" parent="." instance=ExtResource( 4 )]

[connection signal="interacted" from="YSort/RoomElements/Enterables/Desk" to="MinigamesManager" method="_on_Desk_interacted"]
[connection signal="interacted" from="YSort/RoomElements/Enterables/Weights" to="MinigamesManager" method="_on_Weights_interacted"]
[connection signal="interacted" from="YSort/RoomElements/Enterables/Bed" to="MinigamesManager" method="_on_Bed_interacted"]
